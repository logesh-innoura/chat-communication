{"ast":null,"code":"/*! @azure/msal-browser v3.7.0 2024-01-09 */\n'use strict';\n\nimport { OIDC_DEFAULT_SCOPES, invokeAsync, PerformanceEvents, invoke, ThrottlingUtils, ProtocolUtils, AuthError, ProtocolMode, UrlString, ServerResponseType } from '@azure/msal-common';\nimport { StandardInteractionClient } from './StandardInteractionClient.mjs';\nimport { EventType } from '../event/EventType.mjs';\nimport { ApiId, InteractionType, BrowserConstants } from '../utils/BrowserConstants.mjs';\nimport { preconnect, getCurrentUri } from '../utils/BrowserUtils.mjs';\nimport { NativeInteractionClient } from './NativeInteractionClient.mjs';\nimport { NativeMessageHandler } from '../broker/nativeBroker/NativeMessageHandler.mjs';\nimport { createBrowserAuthError } from '../error/BrowserAuthError.mjs';\nimport { InteractionHandler } from '../interaction_handler/InteractionHandler.mjs';\nimport { deserializeResponse } from '../response/ResponseHandler.mjs';\nimport { nativeConnectionNotEstablished, emptyNavigateUri, userCancelled, emptyWindowError, popupWindowError } from '../error/BrowserAuthErrorCodes.mjs';\n\n/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\nclass PopupClient extends StandardInteractionClient {\n  constructor(config, storageImpl, browserCrypto, logger, eventHandler, navigationClient, performanceClient, nativeStorageImpl, nativeMessageHandler, correlationId) {\n    super(config, storageImpl, browserCrypto, logger, eventHandler, navigationClient, performanceClient, nativeMessageHandler, correlationId);\n    // Properly sets this reference for the unload event.\n    this.unloadWindow = this.unloadWindow.bind(this);\n    this.nativeStorage = nativeStorageImpl;\n  }\n  /**\r\n   * Acquires tokens by opening a popup window to the /authorize endpoint of the authority\r\n   * @param request\r\n   */\n  acquireToken(request) {\n    try {\n      const popupName = this.generatePopupName(request.scopes || OIDC_DEFAULT_SCOPES, request.authority || this.config.auth.authority);\n      const popupWindowAttributes = request.popupWindowAttributes || {};\n      // asyncPopups flag is true. Acquires token without first opening popup. Popup will be opened later asynchronously.\n      if (this.config.system.asyncPopups) {\n        this.logger.verbose(\"asyncPopups set to true, acquiring token\");\n        // Passes on popup position and dimensions if in request\n        return this.acquireTokenPopupAsync(request, popupName, popupWindowAttributes);\n      } else {\n        // asyncPopups flag is set to false. Opens popup before acquiring token.\n        this.logger.verbose(\"asyncPopup set to false, opening popup before acquiring token\");\n        const popup = this.openSizedPopup(\"about:blank\", popupName, popupWindowAttributes);\n        return this.acquireTokenPopupAsync(request, popupName, popupWindowAttributes, popup);\n      }\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  }\n  /**\r\n   * Clears local cache for the current user then opens a popup window prompting the user to sign-out of the server\r\n   * @param logoutRequest\r\n   */\n  logout(logoutRequest) {\n    try {\n      this.logger.verbose(\"logoutPopup called\");\n      const validLogoutRequest = this.initializeLogoutRequest(logoutRequest);\n      const popupName = this.generateLogoutPopupName(validLogoutRequest);\n      const authority = logoutRequest && logoutRequest.authority;\n      const mainWindowRedirectUri = logoutRequest && logoutRequest.mainWindowRedirectUri;\n      const popupWindowAttributes = logoutRequest?.popupWindowAttributes || {};\n      // asyncPopups flag is true. Acquires token without first opening popup. Popup will be opened later asynchronously.\n      if (this.config.system.asyncPopups) {\n        this.logger.verbose(\"asyncPopups set to true\");\n        // Passes on popup position and dimensions if in request\n        return this.logoutPopupAsync(validLogoutRequest, popupName, popupWindowAttributes, authority, undefined, mainWindowRedirectUri);\n      } else {\n        // asyncPopups flag is set to false. Opens popup before logging out.\n        this.logger.verbose(\"asyncPopup set to false, opening popup\");\n        const popup = this.openSizedPopup(\"about:blank\", popupName, popupWindowAttributes);\n        return this.logoutPopupAsync(validLogoutRequest, popupName, popupWindowAttributes, authority, popup, mainWindowRedirectUri);\n      }\n    } catch (e) {\n      // Since this function is synchronous we need to reject\n      return Promise.reject(e);\n    }\n  }\n  /**\r\n   * Helper which obtains an access_token for your API via opening a popup window in the user's browser\r\n   * @param validRequest\r\n   * @param popupName\r\n   * @param popup\r\n   * @param popupWindowAttributes\r\n   *\r\n   * @returns A promise that is fulfilled when this function has completed, or rejected if an error was raised.\r\n   */\n  async acquireTokenPopupAsync(request, popupName, popupWindowAttributes, popup) {\n    this.logger.verbose(\"acquireTokenPopupAsync called\");\n    const serverTelemetryManager = this.initializeServerTelemetryManager(ApiId.acquireTokenPopup);\n    const validRequest = await invokeAsync(this.initializeAuthorizationRequest.bind(this), PerformanceEvents.StandardInteractionClientInitializeAuthorizationRequest, this.logger, this.performanceClient, this.correlationId)(request, InteractionType.Popup);\n    preconnect(validRequest.authority);\n    try {\n      // Create auth code request and generate PKCE params\n      const authCodeRequest = await invokeAsync(this.initializeAuthorizationCodeRequest.bind(this), PerformanceEvents.StandardInteractionClientInitializeAuthorizationCodeRequest, this.logger, this.performanceClient, this.correlationId)(validRequest);\n      // Initialize the client\n      const authClient = await invokeAsync(this.createAuthCodeClient.bind(this), PerformanceEvents.StandardInteractionClientCreateAuthCodeClient, this.logger, this.performanceClient, this.correlationId)(serverTelemetryManager, validRequest.authority, validRequest.azureCloudOptions);\n      const isNativeBroker = NativeMessageHandler.isNativeAvailable(this.config, this.logger, this.nativeMessageHandler, request.authenticationScheme);\n      // Start measurement for server calls with native brokering enabled\n      let fetchNativeAccountIdMeasurement;\n      if (isNativeBroker) {\n        fetchNativeAccountIdMeasurement = this.performanceClient.startMeasurement(PerformanceEvents.FetchAccountIdWithNativeBroker, request.correlationId);\n      }\n      // Create acquire token url.\n      const navigateUrl = await authClient.getAuthCodeUrl({\n        ...validRequest,\n        nativeBroker: isNativeBroker\n      });\n      // Create popup interaction handler.\n      const interactionHandler = new InteractionHandler(authClient, this.browserStorage, authCodeRequest, this.logger, this.performanceClient);\n      // Show the UI once the url has been created. Get the window handle for the popup.\n      const popupParameters = {\n        popup,\n        popupName,\n        popupWindowAttributes\n      };\n      const popupWindow = this.initiateAuthRequest(navigateUrl, popupParameters);\n      this.eventHandler.emitEvent(EventType.POPUP_OPENED, InteractionType.Popup, {\n        popupWindow\n      }, null);\n      // Monitor the window for the hash. Return the string value and close the popup when the hash is received. Default timeout is 60 seconds.\n      const responseString = await this.monitorPopupForHash(popupWindow);\n      const serverParams = invoke(deserializeResponse, PerformanceEvents.DeserializeResponse, this.logger, this.performanceClient, this.correlationId)(responseString, this.config.auth.OIDCOptions.serverResponseType, this.logger);\n      // Remove throttle if it exists\n      ThrottlingUtils.removeThrottle(this.browserStorage, this.config.auth.clientId, authCodeRequest);\n      if (serverParams.accountId) {\n        this.logger.verbose(\"Account id found in hash, calling WAM for token\");\n        // end measurement for server call with native brokering enabled\n        if (fetchNativeAccountIdMeasurement) {\n          fetchNativeAccountIdMeasurement.end({\n            success: true,\n            isNativeBroker: true\n          });\n        }\n        if (!this.nativeMessageHandler) {\n          throw createBrowserAuthError(nativeConnectionNotEstablished);\n        }\n        const nativeInteractionClient = new NativeInteractionClient(this.config, this.browserStorage, this.browserCrypto, this.logger, this.eventHandler, this.navigationClient, ApiId.acquireTokenPopup, this.performanceClient, this.nativeMessageHandler, serverParams.accountId, this.nativeStorage, validRequest.correlationId);\n        const {\n          userRequestState\n        } = ProtocolUtils.parseRequestState(this.browserCrypto, validRequest.state);\n        return await nativeInteractionClient.acquireToken({\n          ...validRequest,\n          state: userRequestState,\n          prompt: undefined // Server should handle the prompt, ideally native broker can do this part silently\n        });\n      }\n      // Handle response from hash string.\n      const result = await interactionHandler.handleCodeResponse(serverParams, validRequest);\n      return result;\n    } catch (e) {\n      if (popup) {\n        // Close the synchronous popup if an error is thrown before the window unload event is registered\n        popup.close();\n      }\n      if (e instanceof AuthError) {\n        e.setCorrelationId(this.correlationId);\n        serverTelemetryManager.cacheFailedRequest(e);\n      }\n      throw e;\n    }\n  }\n  /**\r\n   *\r\n   * @param validRequest\r\n   * @param popupName\r\n   * @param requestAuthority\r\n   * @param popup\r\n   * @param mainWindowRedirectUri\r\n   * @param popupWindowAttributes\r\n   */\n  async logoutPopupAsync(validRequest, popupName, popupWindowAttributes, requestAuthority, popup, mainWindowRedirectUri) {\n    this.logger.verbose(\"logoutPopupAsync called\");\n    this.eventHandler.emitEvent(EventType.LOGOUT_START, InteractionType.Popup, validRequest);\n    const serverTelemetryManager = this.initializeServerTelemetryManager(ApiId.logoutPopup);\n    try {\n      // Clear cache on logout\n      await this.clearCacheOnLogout(validRequest.account);\n      // Initialize the client\n      const authClient = await invokeAsync(this.createAuthCodeClient.bind(this), PerformanceEvents.StandardInteractionClientCreateAuthCodeClient, this.logger, this.performanceClient, this.correlationId)(serverTelemetryManager, requestAuthority);\n      try {\n        authClient.authority.endSessionEndpoint;\n      } catch {\n        if (validRequest.account?.homeAccountId && validRequest.postLogoutRedirectUri && authClient.authority.protocolMode === ProtocolMode.OIDC) {\n          void this.browserStorage.removeAccount(validRequest.account?.homeAccountId);\n          this.eventHandler.emitEvent(EventType.LOGOUT_SUCCESS, InteractionType.Popup, validRequest);\n          if (mainWindowRedirectUri) {\n            const navigationOptions = {\n              apiId: ApiId.logoutPopup,\n              timeout: this.config.system.redirectNavigationTimeout,\n              noHistory: false\n            };\n            const absoluteUrl = UrlString.getAbsoluteUrl(mainWindowRedirectUri, getCurrentUri());\n            await this.navigationClient.navigateInternal(absoluteUrl, navigationOptions);\n          }\n          if (popup) {\n            popup.close();\n          }\n          return;\n        }\n      }\n      // Create logout string and navigate user window to logout.\n      const logoutUri = authClient.getLogoutUri(validRequest);\n      this.eventHandler.emitEvent(EventType.LOGOUT_SUCCESS, InteractionType.Popup, validRequest);\n      // Open the popup window to requestUrl.\n      const popupWindow = this.openPopup(logoutUri, {\n        popupName,\n        popupWindowAttributes,\n        popup\n      });\n      this.eventHandler.emitEvent(EventType.POPUP_OPENED, InteractionType.Popup, {\n        popupWindow\n      }, null);\n      await this.monitorPopupForHash(popupWindow).catch(() => {\n        // Swallow any errors related to monitoring the window. Server logout is best effort\n      });\n      if (mainWindowRedirectUri) {\n        const navigationOptions = {\n          apiId: ApiId.logoutPopup,\n          timeout: this.config.system.redirectNavigationTimeout,\n          noHistory: false\n        };\n        const absoluteUrl = UrlString.getAbsoluteUrl(mainWindowRedirectUri, getCurrentUri());\n        this.logger.verbose(\"Redirecting main window to url specified in the request\");\n        this.logger.verbosePii(`Redirecting main window to: ${absoluteUrl}`);\n        await this.navigationClient.navigateInternal(absoluteUrl, navigationOptions);\n      } else {\n        this.logger.verbose(\"No main window navigation requested\");\n      }\n    } catch (e) {\n      if (popup) {\n        // Close the synchronous popup if an error is thrown before the window unload event is registered\n        popup.close();\n      }\n      if (e instanceof AuthError) {\n        e.setCorrelationId(this.correlationId);\n        serverTelemetryManager.cacheFailedRequest(e);\n      }\n      this.browserStorage.setInteractionInProgress(false);\n      this.eventHandler.emitEvent(EventType.LOGOUT_FAILURE, InteractionType.Popup, null, e);\n      this.eventHandler.emitEvent(EventType.LOGOUT_END, InteractionType.Popup);\n      throw e;\n    }\n    this.eventHandler.emitEvent(EventType.LOGOUT_END, InteractionType.Popup);\n  }\n  /**\r\n   * Opens a popup window with given request Url.\r\n   * @param requestUrl\r\n   */\n  initiateAuthRequest(requestUrl, params) {\n    // Check that request url is not empty.\n    if (requestUrl) {\n      this.logger.infoPii(`Navigate to: ${requestUrl}`);\n      // Open the popup window to requestUrl.\n      return this.openPopup(requestUrl, params);\n    } else {\n      // Throw error if request URL is empty.\n      this.logger.error(\"Navigate url is empty\");\n      throw createBrowserAuthError(emptyNavigateUri);\n    }\n  }\n  /**\r\n   * Monitors a window until it loads a url with the same origin.\r\n   * @param popupWindow - window that is being monitored\r\n   * @param timeout - timeout for processing hash once popup is redirected back to application\r\n   */\n  monitorPopupForHash(popupWindow) {\n    return new Promise((resolve, reject) => {\n      this.logger.verbose(\"PopupHandler.monitorPopupForHash - polling started\");\n      const intervalId = setInterval(() => {\n        // Window is closed\n        if (popupWindow.closed) {\n          this.logger.error(\"PopupHandler.monitorPopupForHash - window closed\");\n          clearInterval(intervalId);\n          reject(createBrowserAuthError(userCancelled));\n          return;\n        }\n        let href = \"\";\n        try {\n          /*\r\n           * Will throw if cross origin,\r\n           * which should be caught and ignored\r\n           * since we need the interval to keep running while on STS UI.\r\n           */\n          href = popupWindow.location.href;\n        } catch (e) {}\n        // Don't process blank pages or cross domain\n        if (!href || href === \"about:blank\") {\n          return;\n        }\n        clearInterval(intervalId);\n        let responseString = \"\";\n        const responseType = this.config.auth.OIDCOptions.serverResponseType;\n        if (popupWindow) {\n          if (responseType === ServerResponseType.QUERY) {\n            responseString = popupWindow.location.search;\n          } else {\n            responseString = popupWindow.location.hash;\n          }\n        }\n        this.logger.verbose(\"PopupHandler.monitorPopupForHash - popup window is on same origin as caller\");\n        resolve(responseString);\n      }, this.config.system.pollIntervalMilliseconds);\n    }).finally(() => {\n      this.cleanPopup(popupWindow);\n    });\n  }\n  /**\r\n   * @hidden\r\n   *\r\n   * Configures popup window for login.\r\n   *\r\n   * @param urlNavigate\r\n   * @param title\r\n   * @param popUpWidth\r\n   * @param popUpHeight\r\n   * @param popupWindowAttributes\r\n   * @ignore\r\n   * @hidden\r\n   */\n  openPopup(urlNavigate, popupParams) {\n    try {\n      let popupWindow;\n      // Popup window passed in, setting url to navigate to\n      if (popupParams.popup) {\n        popupWindow = popupParams.popup;\n        this.logger.verbosePii(`Navigating popup window to: ${urlNavigate}`);\n        popupWindow.location.assign(urlNavigate);\n      } else if (typeof popupParams.popup === \"undefined\") {\n        // Popup will be undefined if it was not passed in\n        this.logger.verbosePii(`Opening popup window to: ${urlNavigate}`);\n        popupWindow = this.openSizedPopup(urlNavigate, popupParams.popupName, popupParams.popupWindowAttributes);\n      }\n      // Popup will be null if popups are blocked\n      if (!popupWindow) {\n        throw createBrowserAuthError(emptyWindowError);\n      }\n      if (popupWindow.focus) {\n        popupWindow.focus();\n      }\n      this.currentWindow = popupWindow;\n      window.addEventListener(\"beforeunload\", this.unloadWindow);\n      return popupWindow;\n    } catch (e) {\n      this.logger.error(\"error opening popup \" + e.message);\n      this.browserStorage.setInteractionInProgress(false);\n      throw createBrowserAuthError(popupWindowError);\n    }\n  }\n  /**\r\n   * Helper function to set popup window dimensions and position\r\n   * @param urlNavigate\r\n   * @param popupName\r\n   * @param popupWindowAttributes\r\n   * @returns\r\n   */\n  openSizedPopup(urlNavigate, popupName, popupWindowAttributes) {\n    /**\r\n     * adding winLeft and winTop to account for dual monitor\r\n     * using screenLeft and screenTop for IE8 and earlier\r\n     */\n    const winLeft = window.screenLeft ? window.screenLeft : window.screenX;\n    const winTop = window.screenTop ? window.screenTop : window.screenY;\n    /**\r\n     * window.innerWidth displays browser window\"s height and width excluding toolbars\r\n     * using document.documentElement.clientWidth for IE8 and earlier\r\n     */\n    const winWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;\n    const winHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;\n    let width = popupWindowAttributes.popupSize?.width;\n    let height = popupWindowAttributes.popupSize?.height;\n    let top = popupWindowAttributes.popupPosition?.top;\n    let left = popupWindowAttributes.popupPosition?.left;\n    if (!width || width < 0 || width > winWidth) {\n      this.logger.verbose(\"Default popup window width used. Window width not configured or invalid.\");\n      width = BrowserConstants.POPUP_WIDTH;\n    }\n    if (!height || height < 0 || height > winHeight) {\n      this.logger.verbose(\"Default popup window height used. Window height not configured or invalid.\");\n      height = BrowserConstants.POPUP_HEIGHT;\n    }\n    if (!top || top < 0 || top > winHeight) {\n      this.logger.verbose(\"Default popup window top position used. Window top not configured or invalid.\");\n      top = Math.max(0, winHeight / 2 - BrowserConstants.POPUP_HEIGHT / 2 + winTop);\n    }\n    if (!left || left < 0 || left > winWidth) {\n      this.logger.verbose(\"Default popup window left position used. Window left not configured or invalid.\");\n      left = Math.max(0, winWidth / 2 - BrowserConstants.POPUP_WIDTH / 2 + winLeft);\n    }\n    return window.open(urlNavigate, popupName, `width=${width}, height=${height}, top=${top}, left=${left}, scrollbars=yes`);\n  }\n  /**\r\n   * Event callback to unload main window.\r\n   */\n  unloadWindow(e) {\n    this.browserStorage.cleanRequestByInteractionType(InteractionType.Popup);\n    if (this.currentWindow) {\n      this.currentWindow.close();\n    }\n    // Guarantees browser unload will happen, so no other errors will be thrown.\n    e.preventDefault();\n  }\n  /**\r\n   * Closes popup, removes any state vars created during popup calls.\r\n   * @param popupWindow\r\n   */\n  cleanPopup(popupWindow) {\n    if (popupWindow) {\n      // Close window.\n      popupWindow.close();\n    }\n    // Remove window unload function\n    window.removeEventListener(\"beforeunload\", this.unloadWindow);\n    // Interaction is completed - remove interaction status.\n    this.browserStorage.setInteractionInProgress(false);\n  }\n  /**\r\n   * Generates the name for the popup based on the client id and request\r\n   * @param clientId\r\n   * @param request\r\n   */\n  generatePopupName(scopes, authority) {\n    return `${BrowserConstants.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${scopes.join(\"-\")}.${authority}.${this.correlationId}`;\n  }\n  /**\r\n   * Generates the name for the popup based on the client id and request for logouts\r\n   * @param clientId\r\n   * @param request\r\n   */\n  generateLogoutPopupName(request) {\n    const homeAccountId = request.account && request.account.homeAccountId;\n    return `${BrowserConstants.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${homeAccountId}.${this.correlationId}`;\n  }\n}\nexport { PopupClient };","map":{"version":3,"names":["PopupClient","StandardInteractionClient","constructor","config","storageImpl","browserCrypto","logger","eventHandler","navigationClient","performanceClient","nativeStorageImpl","nativeMessageHandler","correlationId","unloadWindow","bind","nativeStorage","acquireToken","request","popupName","generatePopupName","scopes","OIDC_DEFAULT_SCOPES","authority","auth","popupWindowAttributes","system","asyncPopups","verbose","acquireTokenPopupAsync","popup","openSizedPopup","e","Promise","reject","logout","logoutRequest","validLogoutRequest","initializeLogoutRequest","generateLogoutPopupName","mainWindowRedirectUri","logoutPopupAsync","undefined","serverTelemetryManager","initializeServerTelemetryManager","ApiId","acquireTokenPopup","validRequest","invokeAsync","initializeAuthorizationRequest","PerformanceEvents","StandardInteractionClientInitializeAuthorizationRequest","InteractionType","Popup","preconnect","authCodeRequest","initializeAuthorizationCodeRequest","StandardInteractionClientInitializeAuthorizationCodeRequest","authClient","createAuthCodeClient","StandardInteractionClientCreateAuthCodeClient","azureCloudOptions","isNativeBroker","NativeMessageHandler","isNativeAvailable","authenticationScheme","fetchNativeAccountIdMeasurement","startMeasurement","FetchAccountIdWithNativeBroker","navigateUrl","getAuthCodeUrl","nativeBroker","interactionHandler","InteractionHandler","browserStorage","popupParameters","popupWindow","initiateAuthRequest","emitEvent","EventType","POPUP_OPENED","responseString","monitorPopupForHash","serverParams","invoke","deserializeResponse","DeserializeResponse","OIDCOptions","serverResponseType","ThrottlingUtils","removeThrottle","clientId","accountId","end","success","createBrowserAuthError","nativeConnectionNotEstablished","nativeInteractionClient","NativeInteractionClient","userRequestState","ProtocolUtils","parseRequestState","state","prompt","result","handleCodeResponse","close","AuthError","setCorrelationId","cacheFailedRequest","requestAuthority","LOGOUT_START","logoutPopup","clearCacheOnLogout","account","endSessionEndpoint","homeAccountId","postLogoutRedirectUri","protocolMode","ProtocolMode","OIDC","removeAccount","LOGOUT_SUCCESS","navigationOptions","apiId","timeout","redirectNavigationTimeout","noHistory","absoluteUrl","UrlString","getAbsoluteUrl","getCurrentUri","navigateInternal","logoutUri","getLogoutUri","openPopup","catch","verbosePii","setInteractionInProgress","LOGOUT_FAILURE","LOGOUT_END","requestUrl","params","infoPii","error","emptyNavigateUri","resolve","intervalId","setInterval","closed","clearInterval","userCancelled","href","location","responseType","ServerResponseType","QUERY","search","hash","pollIntervalMilliseconds","finally","cleanPopup","urlNavigate","popupParams","assign","emptyWindowError","focus","currentWindow","window","addEventListener","message","popupWindowError","winLeft","screenLeft","screenX","winTop","screenTop","screenY","winWidth","innerWidth","document","documentElement","clientWidth","body","winHeight","innerHeight","clientHeight","width","popupSize","height","top","popupPosition","left","BrowserConstants","POPUP_WIDTH","POPUP_HEIGHT","Math","max","open","cleanRequestByInteractionType","preventDefault","removeEventListener","POPUP_NAME_PREFIX","join"],"sources":["D:\\selvakumar\\java-chat-repo\\websocket-springboot-01\\Java-chatapp\\chatclient\\node_modules\\@azure\\msal-browser\\src\\interaction_client\\PopupClient.ts"],"sourcesContent":["/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport {\r\n    CommonAuthorizationCodeRequest,\r\n    AuthorizationCodeClient,\r\n    ThrottlingUtils,\r\n    CommonEndSessionRequest,\r\n    UrlString,\r\n    AuthError,\r\n    OIDC_DEFAULT_SCOPES,\r\n    ProtocolUtils,\r\n    PerformanceEvents,\r\n    IPerformanceClient,\r\n    Logger,\r\n    ICrypto,\r\n    ProtocolMode,\r\n    ServerResponseType,\r\n    invokeAsync,\r\n    invoke,\r\n} from \"@azure/msal-common\";\r\nimport { StandardInteractionClient } from \"./StandardInteractionClient\";\r\nimport { EventType } from \"../event/EventType\";\r\nimport {\r\n    InteractionType,\r\n    ApiId,\r\n    BrowserConstants,\r\n} from \"../utils/BrowserConstants\";\r\nimport { EndSessionPopupRequest } from \"../request/EndSessionPopupRequest\";\r\nimport { NavigationOptions } from \"../navigation/NavigationOptions\";\r\nimport * as BrowserUtils from \"../utils/BrowserUtils\";\r\nimport { PopupRequest } from \"../request/PopupRequest\";\r\nimport { NativeInteractionClient } from \"./NativeInteractionClient\";\r\nimport { NativeMessageHandler } from \"../broker/nativeBroker/NativeMessageHandler\";\r\nimport {\r\n    createBrowserAuthError,\r\n    BrowserAuthErrorCodes,\r\n} from \"../error/BrowserAuthError\";\r\nimport { INavigationClient } from \"../navigation/INavigationClient\";\r\nimport { EventHandler } from \"../event/EventHandler\";\r\nimport { BrowserCacheManager } from \"../cache/BrowserCacheManager\";\r\nimport { BrowserConfiguration } from \"../config/Configuration\";\r\nimport { InteractionHandler } from \"../interaction_handler/InteractionHandler\";\r\nimport { PopupWindowAttributes } from \"../request/PopupWindowAttributes\";\r\nimport { EventError } from \"../event/EventMessage\";\r\nimport { AuthenticationResult } from \"../response/AuthenticationResult\";\r\nimport * as ResponseHandler from \"../response/ResponseHandler\";\r\n\r\nexport type PopupParams = {\r\n    popup?: Window | null;\r\n    popupName: string;\r\n    popupWindowAttributes: PopupWindowAttributes;\r\n};\r\n\r\nexport class PopupClient extends StandardInteractionClient {\r\n    private currentWindow: Window | undefined;\r\n    protected nativeStorage: BrowserCacheManager;\r\n\r\n    constructor(\r\n        config: BrowserConfiguration,\r\n        storageImpl: BrowserCacheManager,\r\n        browserCrypto: ICrypto,\r\n        logger: Logger,\r\n        eventHandler: EventHandler,\r\n        navigationClient: INavigationClient,\r\n        performanceClient: IPerformanceClient,\r\n        nativeStorageImpl: BrowserCacheManager,\r\n        nativeMessageHandler?: NativeMessageHandler,\r\n        correlationId?: string\r\n    ) {\r\n        super(\r\n            config,\r\n            storageImpl,\r\n            browserCrypto,\r\n            logger,\r\n            eventHandler,\r\n            navigationClient,\r\n            performanceClient,\r\n            nativeMessageHandler,\r\n            correlationId\r\n        );\r\n        // Properly sets this reference for the unload event.\r\n        this.unloadWindow = this.unloadWindow.bind(this);\r\n        this.nativeStorage = nativeStorageImpl;\r\n    }\r\n\r\n    /**\r\n     * Acquires tokens by opening a popup window to the /authorize endpoint of the authority\r\n     * @param request\r\n     */\r\n    acquireToken(request: PopupRequest): Promise<AuthenticationResult> {\r\n        try {\r\n            const popupName = this.generatePopupName(\r\n                request.scopes || OIDC_DEFAULT_SCOPES,\r\n                request.authority || this.config.auth.authority\r\n            );\r\n            const popupWindowAttributes = request.popupWindowAttributes || {};\r\n\r\n            // asyncPopups flag is true. Acquires token without first opening popup. Popup will be opened later asynchronously.\r\n            if (this.config.system.asyncPopups) {\r\n                this.logger.verbose(\"asyncPopups set to true, acquiring token\");\r\n                // Passes on popup position and dimensions if in request\r\n                return this.acquireTokenPopupAsync(\r\n                    request,\r\n                    popupName,\r\n                    popupWindowAttributes\r\n                );\r\n            } else {\r\n                // asyncPopups flag is set to false. Opens popup before acquiring token.\r\n                this.logger.verbose(\r\n                    \"asyncPopup set to false, opening popup before acquiring token\"\r\n                );\r\n                const popup = this.openSizedPopup(\r\n                    \"about:blank\",\r\n                    popupName,\r\n                    popupWindowAttributes\r\n                );\r\n                return this.acquireTokenPopupAsync(\r\n                    request,\r\n                    popupName,\r\n                    popupWindowAttributes,\r\n                    popup\r\n                );\r\n            }\r\n        } catch (e) {\r\n            return Promise.reject(e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clears local cache for the current user then opens a popup window prompting the user to sign-out of the server\r\n     * @param logoutRequest\r\n     */\r\n    logout(logoutRequest?: EndSessionPopupRequest): Promise<void> {\r\n        try {\r\n            this.logger.verbose(\"logoutPopup called\");\r\n            const validLogoutRequest =\r\n                this.initializeLogoutRequest(logoutRequest);\r\n\r\n            const popupName = this.generateLogoutPopupName(validLogoutRequest);\r\n            const authority = logoutRequest && logoutRequest.authority;\r\n            const mainWindowRedirectUri =\r\n                logoutRequest && logoutRequest.mainWindowRedirectUri;\r\n            const popupWindowAttributes =\r\n                logoutRequest?.popupWindowAttributes || {};\r\n\r\n            // asyncPopups flag is true. Acquires token without first opening popup. Popup will be opened later asynchronously.\r\n            if (this.config.system.asyncPopups) {\r\n                this.logger.verbose(\"asyncPopups set to true\");\r\n                // Passes on popup position and dimensions if in request\r\n                return this.logoutPopupAsync(\r\n                    validLogoutRequest,\r\n                    popupName,\r\n                    popupWindowAttributes,\r\n                    authority,\r\n                    undefined,\r\n                    mainWindowRedirectUri\r\n                );\r\n            } else {\r\n                // asyncPopups flag is set to false. Opens popup before logging out.\r\n                this.logger.verbose(\"asyncPopup set to false, opening popup\");\r\n                const popup = this.openSizedPopup(\r\n                    \"about:blank\",\r\n                    popupName,\r\n                    popupWindowAttributes\r\n                );\r\n                return this.logoutPopupAsync(\r\n                    validLogoutRequest,\r\n                    popupName,\r\n                    popupWindowAttributes,\r\n                    authority,\r\n                    popup,\r\n                    mainWindowRedirectUri\r\n                );\r\n            }\r\n        } catch (e) {\r\n            // Since this function is synchronous we need to reject\r\n            return Promise.reject(e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Helper which obtains an access_token for your API via opening a popup window in the user's browser\r\n     * @param validRequest\r\n     * @param popupName\r\n     * @param popup\r\n     * @param popupWindowAttributes\r\n     *\r\n     * @returns A promise that is fulfilled when this function has completed, or rejected if an error was raised.\r\n     */\r\n    protected async acquireTokenPopupAsync(\r\n        request: PopupRequest,\r\n        popupName: string,\r\n        popupWindowAttributes: PopupWindowAttributes,\r\n        popup?: Window | null\r\n    ): Promise<AuthenticationResult> {\r\n        this.logger.verbose(\"acquireTokenPopupAsync called\");\r\n        const serverTelemetryManager = this.initializeServerTelemetryManager(\r\n            ApiId.acquireTokenPopup\r\n        );\r\n\r\n        const validRequest = await invokeAsync(\r\n            this.initializeAuthorizationRequest.bind(this),\r\n            PerformanceEvents.StandardInteractionClientInitializeAuthorizationRequest,\r\n            this.logger,\r\n            this.performanceClient,\r\n            this.correlationId\r\n        )(request, InteractionType.Popup);\r\n\r\n        BrowserUtils.preconnect(validRequest.authority);\r\n\r\n        try {\r\n            // Create auth code request and generate PKCE params\r\n            const authCodeRequest: CommonAuthorizationCodeRequest =\r\n                await invokeAsync(\r\n                    this.initializeAuthorizationCodeRequest.bind(this),\r\n                    PerformanceEvents.StandardInteractionClientInitializeAuthorizationCodeRequest,\r\n                    this.logger,\r\n                    this.performanceClient,\r\n                    this.correlationId\r\n                )(validRequest);\r\n\r\n            // Initialize the client\r\n            const authClient: AuthorizationCodeClient = await invokeAsync(\r\n                this.createAuthCodeClient.bind(this),\r\n                PerformanceEvents.StandardInteractionClientCreateAuthCodeClient,\r\n                this.logger,\r\n                this.performanceClient,\r\n                this.correlationId\r\n            )(\r\n                serverTelemetryManager,\r\n                validRequest.authority,\r\n                validRequest.azureCloudOptions\r\n            );\r\n\r\n            const isNativeBroker = NativeMessageHandler.isNativeAvailable(\r\n                this.config,\r\n                this.logger,\r\n                this.nativeMessageHandler,\r\n                request.authenticationScheme\r\n            );\r\n            // Start measurement for server calls with native brokering enabled\r\n            let fetchNativeAccountIdMeasurement;\r\n            if (isNativeBroker) {\r\n                fetchNativeAccountIdMeasurement =\r\n                    this.performanceClient.startMeasurement(\r\n                        PerformanceEvents.FetchAccountIdWithNativeBroker,\r\n                        request.correlationId\r\n                    );\r\n            }\r\n\r\n            // Create acquire token url.\r\n            const navigateUrl = await authClient.getAuthCodeUrl({\r\n                ...validRequest,\r\n                nativeBroker: isNativeBroker,\r\n            });\r\n\r\n            // Create popup interaction handler.\r\n            const interactionHandler = new InteractionHandler(\r\n                authClient,\r\n                this.browserStorage,\r\n                authCodeRequest,\r\n                this.logger,\r\n                this.performanceClient\r\n            );\r\n\r\n            // Show the UI once the url has been created. Get the window handle for the popup.\r\n            const popupParameters: PopupParams = {\r\n                popup,\r\n                popupName,\r\n                popupWindowAttributes,\r\n            };\r\n            const popupWindow: Window = this.initiateAuthRequest(\r\n                navigateUrl,\r\n                popupParameters\r\n            );\r\n            this.eventHandler.emitEvent(\r\n                EventType.POPUP_OPENED,\r\n                InteractionType.Popup,\r\n                { popupWindow },\r\n                null\r\n            );\r\n\r\n            // Monitor the window for the hash. Return the string value and close the popup when the hash is received. Default timeout is 60 seconds.\r\n            const responseString = await this.monitorPopupForHash(popupWindow);\r\n\r\n            const serverParams = invoke(\r\n                ResponseHandler.deserializeResponse,\r\n                PerformanceEvents.DeserializeResponse,\r\n                this.logger,\r\n                this.performanceClient,\r\n                this.correlationId\r\n            )(\r\n                responseString,\r\n                this.config.auth.OIDCOptions.serverResponseType,\r\n                this.logger\r\n            );\r\n            // Remove throttle if it exists\r\n            ThrottlingUtils.removeThrottle(\r\n                this.browserStorage,\r\n                this.config.auth.clientId,\r\n                authCodeRequest\r\n            );\r\n\r\n            if (serverParams.accountId) {\r\n                this.logger.verbose(\r\n                    \"Account id found in hash, calling WAM for token\"\r\n                );\r\n                // end measurement for server call with native brokering enabled\r\n                if (fetchNativeAccountIdMeasurement) {\r\n                    fetchNativeAccountIdMeasurement.end({\r\n                        success: true,\r\n                        isNativeBroker: true,\r\n                    });\r\n                }\r\n\r\n                if (!this.nativeMessageHandler) {\r\n                    throw createBrowserAuthError(\r\n                        BrowserAuthErrorCodes.nativeConnectionNotEstablished\r\n                    );\r\n                }\r\n                const nativeInteractionClient = new NativeInteractionClient(\r\n                    this.config,\r\n                    this.browserStorage,\r\n                    this.browserCrypto,\r\n                    this.logger,\r\n                    this.eventHandler,\r\n                    this.navigationClient,\r\n                    ApiId.acquireTokenPopup,\r\n                    this.performanceClient,\r\n                    this.nativeMessageHandler,\r\n                    serverParams.accountId,\r\n                    this.nativeStorage,\r\n                    validRequest.correlationId\r\n                );\r\n                const { userRequestState } = ProtocolUtils.parseRequestState(\r\n                    this.browserCrypto,\r\n                    validRequest.state\r\n                );\r\n                return await nativeInteractionClient.acquireToken({\r\n                    ...validRequest,\r\n                    state: userRequestState,\r\n                    prompt: undefined, // Server should handle the prompt, ideally native broker can do this part silently\r\n                });\r\n            }\r\n\r\n            // Handle response from hash string.\r\n            const result = await interactionHandler.handleCodeResponse(\r\n                serverParams,\r\n                validRequest\r\n            );\r\n\r\n            return result;\r\n        } catch (e) {\r\n            if (popup) {\r\n                // Close the synchronous popup if an error is thrown before the window unload event is registered\r\n                popup.close();\r\n            }\r\n\r\n            if (e instanceof AuthError) {\r\n                (e as AuthError).setCorrelationId(this.correlationId);\r\n                serverTelemetryManager.cacheFailedRequest(e);\r\n            }\r\n            throw e;\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param validRequest\r\n     * @param popupName\r\n     * @param requestAuthority\r\n     * @param popup\r\n     * @param mainWindowRedirectUri\r\n     * @param popupWindowAttributes\r\n     */\r\n    protected async logoutPopupAsync(\r\n        validRequest: CommonEndSessionRequest,\r\n        popupName: string,\r\n        popupWindowAttributes: PopupWindowAttributes,\r\n        requestAuthority?: string,\r\n        popup?: Window | null,\r\n        mainWindowRedirectUri?: string\r\n    ): Promise<void> {\r\n        this.logger.verbose(\"logoutPopupAsync called\");\r\n        this.eventHandler.emitEvent(\r\n            EventType.LOGOUT_START,\r\n            InteractionType.Popup,\r\n            validRequest\r\n        );\r\n\r\n        const serverTelemetryManager = this.initializeServerTelemetryManager(\r\n            ApiId.logoutPopup\r\n        );\r\n\r\n        try {\r\n            // Clear cache on logout\r\n            await this.clearCacheOnLogout(validRequest.account);\r\n\r\n            // Initialize the client\r\n            const authClient = await invokeAsync(\r\n                this.createAuthCodeClient.bind(this),\r\n                PerformanceEvents.StandardInteractionClientCreateAuthCodeClient,\r\n                this.logger,\r\n                this.performanceClient,\r\n                this.correlationId\r\n            )(serverTelemetryManager, requestAuthority);\r\n\r\n            try {\r\n                authClient.authority.endSessionEndpoint;\r\n            } catch {\r\n                if (\r\n                    validRequest.account?.homeAccountId &&\r\n                    validRequest.postLogoutRedirectUri &&\r\n                    authClient.authority.protocolMode === ProtocolMode.OIDC\r\n                ) {\r\n                    void this.browserStorage.removeAccount(\r\n                        validRequest.account?.homeAccountId\r\n                    );\r\n\r\n                    this.eventHandler.emitEvent(\r\n                        EventType.LOGOUT_SUCCESS,\r\n                        InteractionType.Popup,\r\n                        validRequest\r\n                    );\r\n\r\n                    if (mainWindowRedirectUri) {\r\n                        const navigationOptions: NavigationOptions = {\r\n                            apiId: ApiId.logoutPopup,\r\n                            timeout:\r\n                                this.config.system.redirectNavigationTimeout,\r\n                            noHistory: false,\r\n                        };\r\n                        const absoluteUrl = UrlString.getAbsoluteUrl(\r\n                            mainWindowRedirectUri,\r\n                            BrowserUtils.getCurrentUri()\r\n                        );\r\n                        await this.navigationClient.navigateInternal(\r\n                            absoluteUrl,\r\n                            navigationOptions\r\n                        );\r\n                    }\r\n\r\n                    if (popup) {\r\n                        popup.close();\r\n                    }\r\n\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // Create logout string and navigate user window to logout.\r\n            const logoutUri: string = authClient.getLogoutUri(validRequest);\r\n\r\n            this.eventHandler.emitEvent(\r\n                EventType.LOGOUT_SUCCESS,\r\n                InteractionType.Popup,\r\n                validRequest\r\n            );\r\n\r\n            // Open the popup window to requestUrl.\r\n            const popupWindow = this.openPopup(logoutUri, {\r\n                popupName,\r\n                popupWindowAttributes,\r\n                popup,\r\n            });\r\n            this.eventHandler.emitEvent(\r\n                EventType.POPUP_OPENED,\r\n                InteractionType.Popup,\r\n                { popupWindow },\r\n                null\r\n            );\r\n\r\n            await this.monitorPopupForHash(popupWindow).catch(() => {\r\n                // Swallow any errors related to monitoring the window. Server logout is best effort\r\n            });\r\n\r\n            if (mainWindowRedirectUri) {\r\n                const navigationOptions: NavigationOptions = {\r\n                    apiId: ApiId.logoutPopup,\r\n                    timeout: this.config.system.redirectNavigationTimeout,\r\n                    noHistory: false,\r\n                };\r\n                const absoluteUrl = UrlString.getAbsoluteUrl(\r\n                    mainWindowRedirectUri,\r\n                    BrowserUtils.getCurrentUri()\r\n                );\r\n\r\n                this.logger.verbose(\r\n                    \"Redirecting main window to url specified in the request\"\r\n                );\r\n                this.logger.verbosePii(\r\n                    `Redirecting main window to: ${absoluteUrl}`\r\n                );\r\n                await this.navigationClient.navigateInternal(\r\n                    absoluteUrl,\r\n                    navigationOptions\r\n                );\r\n            } else {\r\n                this.logger.verbose(\"No main window navigation requested\");\r\n            }\r\n        } catch (e) {\r\n            if (popup) {\r\n                // Close the synchronous popup if an error is thrown before the window unload event is registered\r\n                popup.close();\r\n            }\r\n\r\n            if (e instanceof AuthError) {\r\n                (e as AuthError).setCorrelationId(this.correlationId);\r\n                serverTelemetryManager.cacheFailedRequest(e);\r\n            }\r\n            this.browserStorage.setInteractionInProgress(false);\r\n            this.eventHandler.emitEvent(\r\n                EventType.LOGOUT_FAILURE,\r\n                InteractionType.Popup,\r\n                null,\r\n                e as EventError\r\n            );\r\n            this.eventHandler.emitEvent(\r\n                EventType.LOGOUT_END,\r\n                InteractionType.Popup\r\n            );\r\n            throw e;\r\n        }\r\n\r\n        this.eventHandler.emitEvent(\r\n            EventType.LOGOUT_END,\r\n            InteractionType.Popup\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Opens a popup window with given request Url.\r\n     * @param requestUrl\r\n     */\r\n    initiateAuthRequest(requestUrl: string, params: PopupParams): Window {\r\n        // Check that request url is not empty.\r\n        if (requestUrl) {\r\n            this.logger.infoPii(`Navigate to: ${requestUrl}`);\r\n            // Open the popup window to requestUrl.\r\n            return this.openPopup(requestUrl, params);\r\n        } else {\r\n            // Throw error if request URL is empty.\r\n            this.logger.error(\"Navigate url is empty\");\r\n            throw createBrowserAuthError(\r\n                BrowserAuthErrorCodes.emptyNavigateUri\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Monitors a window until it loads a url with the same origin.\r\n     * @param popupWindow - window that is being monitored\r\n     * @param timeout - timeout for processing hash once popup is redirected back to application\r\n     */\r\n    monitorPopupForHash(popupWindow: Window): Promise<string> {\r\n        return new Promise<string>((resolve, reject) => {\r\n            this.logger.verbose(\r\n                \"PopupHandler.monitorPopupForHash - polling started\"\r\n            );\r\n\r\n            const intervalId = setInterval(() => {\r\n                // Window is closed\r\n                if (popupWindow.closed) {\r\n                    this.logger.error(\r\n                        \"PopupHandler.monitorPopupForHash - window closed\"\r\n                    );\r\n                    clearInterval(intervalId);\r\n                    reject(\r\n                        createBrowserAuthError(\r\n                            BrowserAuthErrorCodes.userCancelled\r\n                        )\r\n                    );\r\n                    return;\r\n                }\r\n\r\n                let href = \"\";\r\n                try {\r\n                    /*\r\n                     * Will throw if cross origin,\r\n                     * which should be caught and ignored\r\n                     * since we need the interval to keep running while on STS UI.\r\n                     */\r\n                    href = popupWindow.location.href;\r\n                } catch (e) {}\r\n\r\n                // Don't process blank pages or cross domain\r\n                if (!href || href === \"about:blank\") {\r\n                    return;\r\n                }\r\n                clearInterval(intervalId);\r\n\r\n                let responseString = \"\";\r\n                const responseType =\r\n                    this.config.auth.OIDCOptions.serverResponseType;\r\n                if (popupWindow) {\r\n                    if (responseType === ServerResponseType.QUERY) {\r\n                        responseString = popupWindow.location.search;\r\n                    } else {\r\n                        responseString = popupWindow.location.hash;\r\n                    }\r\n                }\r\n\r\n                this.logger.verbose(\r\n                    \"PopupHandler.monitorPopupForHash - popup window is on same origin as caller\"\r\n                );\r\n\r\n                resolve(responseString);\r\n            }, this.config.system.pollIntervalMilliseconds);\r\n        }).finally(() => {\r\n            this.cleanPopup(popupWindow);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * @hidden\r\n     *\r\n     * Configures popup window for login.\r\n     *\r\n     * @param urlNavigate\r\n     * @param title\r\n     * @param popUpWidth\r\n     * @param popUpHeight\r\n     * @param popupWindowAttributes\r\n     * @ignore\r\n     * @hidden\r\n     */\r\n    openPopup(urlNavigate: string, popupParams: PopupParams): Window {\r\n        try {\r\n            let popupWindow;\r\n            // Popup window passed in, setting url to navigate to\r\n            if (popupParams.popup) {\r\n                popupWindow = popupParams.popup;\r\n                this.logger.verbosePii(\r\n                    `Navigating popup window to: ${urlNavigate}`\r\n                );\r\n                popupWindow.location.assign(urlNavigate);\r\n            } else if (typeof popupParams.popup === \"undefined\") {\r\n                // Popup will be undefined if it was not passed in\r\n                this.logger.verbosePii(\r\n                    `Opening popup window to: ${urlNavigate}`\r\n                );\r\n                popupWindow = this.openSizedPopup(\r\n                    urlNavigate,\r\n                    popupParams.popupName,\r\n                    popupParams.popupWindowAttributes\r\n                );\r\n            }\r\n\r\n            // Popup will be null if popups are blocked\r\n            if (!popupWindow) {\r\n                throw createBrowserAuthError(\r\n                    BrowserAuthErrorCodes.emptyWindowError\r\n                );\r\n            }\r\n            if (popupWindow.focus) {\r\n                popupWindow.focus();\r\n            }\r\n            this.currentWindow = popupWindow;\r\n            window.addEventListener(\"beforeunload\", this.unloadWindow);\r\n\r\n            return popupWindow;\r\n        } catch (e) {\r\n            this.logger.error(\r\n                \"error opening popup \" + (e as AuthError).message\r\n            );\r\n            this.browserStorage.setInteractionInProgress(false);\r\n            throw createBrowserAuthError(\r\n                BrowserAuthErrorCodes.popupWindowError\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Helper function to set popup window dimensions and position\r\n     * @param urlNavigate\r\n     * @param popupName\r\n     * @param popupWindowAttributes\r\n     * @returns\r\n     */\r\n    openSizedPopup(\r\n        urlNavigate: string,\r\n        popupName: string,\r\n        popupWindowAttributes: PopupWindowAttributes\r\n    ): Window | null {\r\n        /**\r\n         * adding winLeft and winTop to account for dual monitor\r\n         * using screenLeft and screenTop for IE8 and earlier\r\n         */\r\n        const winLeft = window.screenLeft ? window.screenLeft : window.screenX;\r\n        const winTop = window.screenTop ? window.screenTop : window.screenY;\r\n        /**\r\n         * window.innerWidth displays browser window\"s height and width excluding toolbars\r\n         * using document.documentElement.clientWidth for IE8 and earlier\r\n         */\r\n        const winWidth =\r\n            window.innerWidth ||\r\n            document.documentElement.clientWidth ||\r\n            document.body.clientWidth;\r\n        const winHeight =\r\n            window.innerHeight ||\r\n            document.documentElement.clientHeight ||\r\n            document.body.clientHeight;\r\n\r\n        let width = popupWindowAttributes.popupSize?.width;\r\n        let height = popupWindowAttributes.popupSize?.height;\r\n        let top = popupWindowAttributes.popupPosition?.top;\r\n        let left = popupWindowAttributes.popupPosition?.left;\r\n\r\n        if (!width || width < 0 || width > winWidth) {\r\n            this.logger.verbose(\r\n                \"Default popup window width used. Window width not configured or invalid.\"\r\n            );\r\n            width = BrowserConstants.POPUP_WIDTH;\r\n        }\r\n\r\n        if (!height || height < 0 || height > winHeight) {\r\n            this.logger.verbose(\r\n                \"Default popup window height used. Window height not configured or invalid.\"\r\n            );\r\n            height = BrowserConstants.POPUP_HEIGHT;\r\n        }\r\n\r\n        if (!top || top < 0 || top > winHeight) {\r\n            this.logger.verbose(\r\n                \"Default popup window top position used. Window top not configured or invalid.\"\r\n            );\r\n            top = Math.max(\r\n                0,\r\n                winHeight / 2 - BrowserConstants.POPUP_HEIGHT / 2 + winTop\r\n            );\r\n        }\r\n\r\n        if (!left || left < 0 || left > winWidth) {\r\n            this.logger.verbose(\r\n                \"Default popup window left position used. Window left not configured or invalid.\"\r\n            );\r\n            left = Math.max(\r\n                0,\r\n                winWidth / 2 - BrowserConstants.POPUP_WIDTH / 2 + winLeft\r\n            );\r\n        }\r\n\r\n        return window.open(\r\n            urlNavigate,\r\n            popupName,\r\n            `width=${width}, height=${height}, top=${top}, left=${left}, scrollbars=yes`\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Event callback to unload main window.\r\n     */\r\n    unloadWindow(e: Event): void {\r\n        this.browserStorage.cleanRequestByInteractionType(\r\n            InteractionType.Popup\r\n        );\r\n        if (this.currentWindow) {\r\n            this.currentWindow.close();\r\n        }\r\n        // Guarantees browser unload will happen, so no other errors will be thrown.\r\n        e.preventDefault();\r\n    }\r\n\r\n    /**\r\n     * Closes popup, removes any state vars created during popup calls.\r\n     * @param popupWindow\r\n     */\r\n    cleanPopup(popupWindow?: Window): void {\r\n        if (popupWindow) {\r\n            // Close window.\r\n            popupWindow.close();\r\n        }\r\n        // Remove window unload function\r\n        window.removeEventListener(\"beforeunload\", this.unloadWindow);\r\n\r\n        // Interaction is completed - remove interaction status.\r\n        this.browserStorage.setInteractionInProgress(false);\r\n    }\r\n\r\n    /**\r\n     * Generates the name for the popup based on the client id and request\r\n     * @param clientId\r\n     * @param request\r\n     */\r\n    generatePopupName(scopes: Array<string>, authority: string): string {\r\n        return `${BrowserConstants.POPUP_NAME_PREFIX}.${\r\n            this.config.auth.clientId\r\n        }.${scopes.join(\"-\")}.${authority}.${this.correlationId}`;\r\n    }\r\n\r\n    /**\r\n     * Generates the name for the popup based on the client id and request for logouts\r\n     * @param clientId\r\n     * @param request\r\n     */\r\n    generateLogoutPopupName(request: CommonEndSessionRequest): string {\r\n        const homeAccountId = request.account && request.account.homeAccountId;\r\n        return `${BrowserConstants.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${homeAccountId}.${this.correlationId}`;\r\n    }\r\n}\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}